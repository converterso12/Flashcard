<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Vocabulary</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression/dist/browser-image-compression.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --accent-color: #ff7e5f;
            --text-color: #333;
            --light-text: #f8f9fa;
            --background-color: #f5f7fa;
            --card-background: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 10px;
            --table-row-odd: #f9f9f9;
            --table-row-even: #ffffff;
            --table-border: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        nav a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        nav a.active, nav a:hover {
            background-color: var(--primary-color);
            color: var(--light-text);
        }

        .management-container {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .toolbar-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .search-box input {
            padding: 8px 12px;
            border: none;
            background: transparent;
            font-family: 'Poppins', sans-serif;
            width: 200px;
        }

        .search-box input:focus {
            outline: none;
        }

        .search-box button {
            background-color: transparent;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            color: var(--primary-color);
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background-color: #3a41b0;
        }

        .btn.secondary {
            background-color: #e0e0e0;
            color: var(--text-color);
        }

        .btn.secondary:hover {
            background-color: #d0d0d0;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--table-border);
        }

        th {
            background-color: var(--primary-color);
            color: var(--light-text);
            font-weight: 500;
        }

        tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        tr:nth-child(odd) {
            background-color: var(--table-row-odd);
        }

        tr:hover {
            background-color: #f0f0f0;
        }

        .action-btn {
            padding: 5px 10px;
            margin: 0 3px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background-color: #4CAF50;
            color: white;
        }

        .edit-btn:hover {
            background-color: #3e8e41;
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }

        .save-btn {
            background-color: #2196F3;
            color: white;
        }

        .save-btn:hover {
            background-color: #0b7dda;
        }

        .cancel-btn {
            background-color: #ff9800;
            color: white;
        }

        .cancel-btn:hover {
            background-color: #e68a00;
        }

        .editable {
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            font-family: 'Poppins', sans-serif;
            width: 100%;
        }

        .editable:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .image-cell {
            position: relative;
        }

        .image-cell img.thumbnail {
            max-width: 80px;
            max-height: 60px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.3s;
            object-fit: cover;
        }

        .image-cell img.thumbnail:hover {
            transform: scale(1.1);
        }

        .image-hint {
            display: block;
            font-size: 0.7rem;
            color: #666;
            margin-top: 3px;
        }

        /* Upload Progress Styles */
        .upload-progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin: 5px 0;
        }

        .upload-progress-bar {
            height: 20px;
            background-color: var(--primary-color);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s;
        }

        .upload-progress-text {
            display: block;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-color);
        }

        /* Compression Info */
        .compression-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        /* Image Zoom Modal */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            overflow: auto;
        }

        .modal-content {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            flex-direction: column;
        }

        .modal-image {
            max-width: 90%;
            max-height: 80vh;
            object-fit: contain;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Excel Import Modal */
        .excel-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            overflow: auto;
        }

        .excel-modal-content {
            background-color: var(--card-background);
            margin: 5% auto;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        .close-excel-modal {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .close-excel-modal:hover {
            color: var(--text-color);
        }

        .excel-upload-area {
            border: 2px dashed #ccc;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
        }

        .excel-upload-area:hover {
            border-color: var(--primary-color);
        }

        .excel-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: var(--primary-color);
            font-size: 3rem;
        }

        .excel-upload-label p {
            margin-top: 10px;
            font-size: 1rem;
            color: var(--text-color);
        }

        .excel-preview {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .excel-preview table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .excel-preview th, .excel-preview td {
            padding: 8px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }

        .excel-preview th {
            background-color: var(--primary-color);
            color: white;
        }

        .excel-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
            }
            
            .toolbar-group {
                flex-direction: column;
                width: 100%;
            }
            
            .search-box input {
                width: 100%;
            }
            
            th, td {
                padding: 8px;
                font-size: 0.9rem;
            }
            
            .action-btn {
                padding: 3px 6px;
                margin: 0 2px;
                font-size: 0.8rem;
            }
            
            .excel-modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Manage Vocabulary</h1>
            <nav>
                <a href="index.html">Flashcards</a>
                <a href="manage.html" class="active">Manage Vocabulary</a>
            </nav>
        </header>

        <div class="management-container">
            <div class="toolbar">
                <div class="toolbar-group">
                    <button id="add-row-btn" class="btn"><i class="fas fa-plus"></i> Add New</button>
                    <button id="import-excel-btn" class="btn secondary"><i class="fas fa-file-import"></i> Import Excel</button>
                    <button id="export-excel-btn" class="btn secondary"><i class="fas fa-file-export"></i> Export Excel</button>
                    <button id="download-template-btn" class="btn secondary"><i class="fas fa-file-download"></i> Download Template</button>
                </div>
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Search vocabulary...">
                    <button id="search-btn"><i class="fas fa-search"></i></button>
                </div>
            </div>

            <div class="table-container">
                <table id="vocabulary-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Hanzi</th>
                            <th>Image</th>
                            <th>Pinyin</th>
                            <th>Indonesia</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Image Zoom Modal -->
    <div id="image-modal" class="image-modal">
        <span class="close-modal">&times;</span>
        <div class="modal-content">
            <img id="modal-image" class="modal-image" src="" alt="Enlarged Image">
        </div>
    </div>

    <!-- Excel Import Modal -->
    <div id="excel-modal" class="excel-modal">
        <div class="excel-modal-content">
            <span class="close-excel-modal">&times;</span>
            <h2>Import Vocabulary from Excel</h2>
            <div class="excel-upload-area" id="excel-upload-area">
                <input type="file" id="excel-input" accept=".xlsx,.xls,.csv" style="display: none;">
                <label for="excel-input" class="excel-upload-label">
                    <i class="fas fa-file-excel"></i>
                    <p>Click to browse or drag and drop Excel file</p>
                    <small>Supports .xlsx, .xls, and .csv formats</small>
                </label>
                <div class="excel-preview" id="excel-preview"></div>
                <div class="excel-actions">
                    <button id="cancel-excel-import" class="btn secondary">Cancel</button>
                    <button id="confirm-excel-import" class="btn">Import Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBElGPkZSO_6j9VUl-7olahGASNw0YuAcE",
            authDomain: "flashcardapps-bf86b.firebaseapp.com",
            databaseURL: "https://flashcardapps-bf86b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "flashcardapps-bf86b",
            storageBucket: "flashcardapps-bf86b.firebasestorage.app",
            messagingSenderId: "42781565213",
            appId: "1:42781565213:web:a0e27d81ebba3191df01f4",
            measurementId: "G-GH43L9D2RK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Cloudinary configuration
        const cloudName = 'dzeemdq9x';
        const uploadPreset = 'ml_default';

        // Image compression options
        const compressionOptions = {
            maxSizeMB: 0.5,
            maxWidthOrHeight: 1200,
            useWebWorker: true,
            fileType: 'image/jpeg',
            initialQuality: 0.7
        };

        // Main App Logic
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const vocabularyTable = document.getElementById('vocabulary-table').getElementsByTagName('tbody')[0];
            const addRowBtn = document.getElementById('add-row-btn');
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const importExcelBtn = document.getElementById('import-excel-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const downloadTemplateBtn = document.getElementById('download-template-btn');
            const imageModal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            const closeModal = document.querySelector('.close-modal');
            const excelModal = document.getElementById('excel-modal');
            const excelInput = document.getElementById('excel-input');
            const excelPreview = document.getElementById('excel-preview');
            const cancelExcelImport = document.getElementById('cancel-excel-import');
            const confirmExcelImport = document.getElementById('confirm-excel-import');
            const closeExcelModal = document.querySelector('.close-excel-modal');

            // Global Variables
            let vocabulary = [];
            let currentEditingRow = null;
            let currentImageUrl = null;
            let excelImportData = [];

            // Load vocabulary from Firebase
            function loadVocabulary() {
                const vocabRef = ref(database, 'vocabulary');
                
                onValue(vocabRef, (snapshot) => {
                    const data = snapshot.val();
                    vocabularyTable.innerHTML = '';
                    
                    if (data) {
                        vocabulary = Object.entries(data).map(([id, item]) => ({ id, ...item }));
                        vocabulary.forEach((item, index) => {
                            addRowToTable(item, index + 1);
                        });
                    } else {
                        vocabulary = [];
                    }
                });
            }

            // Add a row to the table
            function addRowToTable(item, index, isNew = false) {
                const row = vocabularyTable.insertRow();
                row.dataset.id = item.id;
                
                // Number cell
                const numberCell = row.insertCell();
                numberCell.textContent = index;
                
                // Hanzi cell
                const hanziCell = row.insertCell();
                if (isNew) {
                    hanziCell.innerHTML = `<input type="text" class="editable" value="${item.hanzi || ''}" placeholder="汉字">`;
                } else {
                    hanziCell.textContent = item.hanzi;
                }
                
                // Image cell
                const imageCell = row.insertCell();
                imageCell.className = 'image-cell';
                if (isNew) {
                    imageCell.innerHTML = `<button class="btn" onclick="uploadImage('${item.id}')">Add Image</button>`;
                } else if (item.imageUrl) {
                    imageCell.innerHTML = `
                        <img src="${item.imageUrl}" 
                             alt="${item.hanzi}" 
                             class="thumbnail" 
                             onclick="showImageModal('${item.imageUrl}')"
                             oncontextmenu="uploadImage('${item.id}'); return false;">
                        
                    `;
                } else {
                    imageCell.innerHTML = `<button class="btn" onclick="uploadImage('${item.id}')">Add Image</button>`;
                }
                
                // Pinyin cell
                const pinyinCell = row.insertCell();
                if (isNew) {
                    pinyinCell.innerHTML = `<input type="text" class="editable" value="${item.pinyin || ''}" placeholder="pīnyīn">`;
                } else {
                    pinyinCell.textContent = item.pinyin;
                }
                
                // Indonesia cell
                const indonesiaCell = row.insertCell();
                if (isNew) {
                    indonesiaCell.innerHTML = `<input type="text" class="editable" value="${item.indonesia || ''}" placeholder="Terjemahan">`;
                } else {
                    indonesiaCell.textContent = item.indonesia;
                }
                
                // Category cell
                const categoryCell = row.insertCell();
                if (isNew) {
                    categoryCell.innerHTML = `<input type="text" class="editable" value="${item.category || ''}" placeholder="Kategori (opsional)">`;
                } else {
                    categoryCell.textContent = item.category || '';
                }
                
                // Actions cell
                const actionsCell = row.insertCell();
                if (isNew) {
                    actionsCell.innerHTML = `
                        <button class="action-btn save-btn" data-id="${item.id}"><i class="fas fa-save"></i> Save</button>
                        <button class="action-btn cancel-btn" data-id="${item.id}"><i class="fas fa-times"></i> Cancel</button>
                    `;
                } else {
                    actionsCell.innerHTML = `
                        <button class="action-btn edit-btn" data-id="${item.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="action-btn delete-btn" data-id="${item.id}"><i class="fas fa-trash"></i> Delete</button>
                    `;
                }
            }

            // Show image in modal
            function showImageModal(imageUrl) {
                modalImage.src = imageUrl;
                imageModal.style.display = 'block';
            }

            // Compress image before upload
            async function compressImage(file) {
                try {
                    console.log('Original file size:', (file.size / 1024 / 1024).toFixed(2), 'MB');
                    
                    const compressedFile = await imageCompression(file, compressionOptions);
                    
                    console.log('Compressed file size:', (compressedFile.size / 1024 / 1024).toFixed(2), 'MB');
                    console.log('Compression ratio:', (file.size / compressedFile.size).toFixed(2), 'x smaller');
                    
                    return compressedFile;
                } catch (error) {
                    console.error('Image compression error:', error);
                    throw error;
                }
            }

            // Upload image function
            async function uploadImage(id) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (!row) return;
                    
                    const imgCell = row.cells[2];
                    
                    try {
                        // Show loading state
                        imgCell.innerHTML = `
                            <div style="text-align: center;">
                                <div class="spinner"></div>
                                <p class="compression-info">Compressing image...</p>
                            </div>
                        `;
                        
                        // Compress the image
                        const compressedFile = await compressImage(file);
                        
                        // Update UI to show compression was successful
                        imgCell.innerHTML = `
                            <div class="upload-progress-container">
                                <div class="upload-progress-bar"></div>
                                <span class="upload-progress-text">0%</span>
                            </div>
                            <p class="compression-info">Uploading compressed image (${(compressedFile.size / 1024).toFixed(1)}KB)...</p>
                        `;
                        
                        const progressBar = imgCell.querySelector('.upload-progress-bar');
                        const progressText = imgCell.querySelector('.upload-progress-text');
                        
                        // Upload to Cloudinary
                        const formData = new FormData();
                        formData.append('file', compressedFile);
                        formData.append('upload_preset', uploadPreset);
                        
                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`);
                        
                        xhr.upload.onprogress = (e) => {
                            if (e.lengthComputable) {
                                const percent = Math.round((e.loaded / e.total) * 100);
                                progressBar.style.width = `${percent}%`;
                                progressText.textContent = `${percent}%`;
                            }
                        };
                        
                        xhr.onload = () => {
                            if (xhr.status === 200) {
                                const response = JSON.parse(xhr.responseText);
                                currentImageUrl = response.secure_url;
                                
                                // Update the image cell
                                imgCell.innerHTML = `
                                    <img src="${currentImageUrl}" 
                                         alt="Preview" 
                                         class="thumbnail" 
                                         onclick="showImageModal('${currentImageUrl}')"
                                         oncontextmenu="uploadImage('${id}'); return false;">
                                    <span class="image-hint">Click to enlarge<br>Right-click to change</span>
                                `;
                            } else {
                                console.error('Upload failed:', xhr.responseText);
                                imgCell.innerHTML = `
                                    <button class="btn" onclick="uploadImage('${id}')">Try Again</button>
                                    <p class="compression-info">Upload failed. Click to retry.</p>
                                `;
                            }
                        };
                        
                        xhr.onerror = () => {
                            console.error('Upload error:', xhr.statusText);
                            imgCell.innerHTML = `
                                <button class="btn" onclick="uploadImage('${id}')">Try Again</button>
                                <p class="compression-info">Upload error. Click to retry.</p>
                            `;
                        };
                        
                        xhr.send(formData);
                    } catch (error) {
                        console.error('Error during image processing:', error);
                        imgCell.innerHTML = `
                            <button class="btn" onclick="uploadImage('${id}')">Try Again</button>
                            <p class="compression-info">Error processing image. Click to retry.</p>
                        `;
                    }
                };
                
                input.click();
            }

            // Add a new row for creating vocabulary
            function addNewRow() {
                const newItem = {
                    id: `temp-${Date.now()}`,
                    hanzi: '',
                    pinyin: '',
                    indonesia: '',
                    category: ''
                };
                
                addRowToTable(newItem, vocabulary.length + 1, true);
                vocabularyTable.scrollTop = vocabularyTable.scrollHeight;
            }

            // Save a new or edited vocabulary item
            function saveVocabulary(row) {
                const id = row.dataset.id;
                const cells = row.cells;
                
                const hanzi = cells[1].querySelector('.editable').value.trim();
                const pinyin = cells[3].querySelector('.editable').value.trim();
                const indonesia = cells[4].querySelector('.editable').value.trim();
                const category = cells[5].querySelector('.editable')?.value.trim() || '';
                
                if (!hanzi || !pinyin || !indonesia) {
                    alert('Please fill in all required fields (Hanzi, Pinyin, Indonesia)');
                    return;
                }
                
                const vocabItem = {
                    hanzi,
                    pinyin,
                    indonesia,
                    category: category || null
                };
                
                if (currentImageUrl) {
                    vocabItem.imageUrl = currentImageUrl;
                }
                
                // If it's a new item (temp ID)
                if (id.startsWith('temp')) {
                    const newVocabRef = push(ref(database, 'vocabulary'));
                    set(newVocabRef, vocabItem)
                        .then(() => {
                            alert('Vocabulary added successfully!');
                            currentImageUrl = null;
                        })
                        .catch(error => {
                            console.error('Error adding vocabulary:', error);
                            alert('Failed to add vocabulary');
                        });
                } else {
                    // Update existing item
                    update(ref(database, `vocabulary/${id}`), vocabItem)
                        .then(() => {
                            alert('Vocabulary updated successfully!');
                            currentImageUrl = null;
                        })
                        .catch(error => {
                            console.error('Error updating vocabulary:', error);
                            alert('Failed to update vocabulary');
                        });
                }
            }

            // Edit a vocabulary item
            function editVocabulary(row) {
                if (currentEditingRow) return; // Only allow editing one row at a time
                
                currentEditingRow = row;
                const id = row.dataset.id;
                const item = vocabulary.find(v => v.id === id);
                
                if (!item) return;
                
                // Replace cells with editable inputs
                const cells = row.cells;
                
                // Hanzi
                cells[1].innerHTML = `<input type="text" class="editable" value="${item.hanzi || ''}">`;
                
                // Image (click to change)
                cells[2].innerHTML = item.imageUrl ? 
                    `<img src="${item.imageUrl}" 
                         alt="${item.hanzi}" 
                         class="thumbnail" 
                         onclick="showImageModal('${item.imageUrl}')"
                         oncontextmenu="uploadImage('${id}'); return false;">
                    <span class="image-hint">Click to enlarge<br>Right-click to change</span>` : 
                    `<button class="btn" onclick="uploadImage('${id}')">Add Image</button>`;
                
                // Pinyin
                cells[3].innerHTML = `<input type="text" class="editable" value="${item.pinyin || ''}">`;
                
                // Indonesia
                cells[4].innerHTML = `<input type="text" class="editable" value="${item.indonesia || ''}">`;
                
                // Category
                cells[5].innerHTML = `<input type="text" class="editable" value="${item.category || ''}" placeholder="Optional">`;
                
                // Actions
                cells[6].innerHTML = `
                    <button class="action-btn save-btn" data-id="${id}"><i class="fas fa-save"></i> Save</button>
                    <button class="action-btn cancel-btn" data-id="${id}"><i class="fas fa-times"></i> Cancel</button>
                `;
            }

            // Cancel editing
            function cancelEdit(row) {
                const id = row.dataset.id;
                const item = vocabulary.find(v => v.id === id);
                
                if (item) {
                    // If it's a new item (temp ID), remove the row
                    if (id.startsWith('temp')) {
                        row.remove();
                    } else {
                        // Otherwise, revert to non-editable view
                        const index = vocabulary.findIndex(v => v.id === id) + 1;
                        row.innerHTML = '';
                        addRowToTable(item, index);
                    }
                }
                
                currentEditingRow = null;
                currentImageUrl = null;
            }

            // Delete a vocabulary item
            function deleteVocabulary(id) {
                if (confirm('Are you sure you want to delete this vocabulary item?')) {
                    remove(ref(database, `vocabulary/${id}`))
                        .then(() => {
                            alert('Vocabulary deleted successfully!');
                        })
                        .catch(error => {
                            console.error('Error deleting vocabulary:', error);
                            alert('Failed to delete vocabulary');
                        });
                }
            }

            // Search vocabulary
            function searchVocabulary() {
                const searchTerm = searchInput.value.trim().toLowerCase();
                
                if (!searchTerm) {
                    loadVocabulary();
                    return;
                }
                
                const filtered = vocabulary.filter(item => 
                    item.hanzi.toLowerCase().includes(searchTerm) ||
                    item.pinyin.toLowerCase().includes(searchTerm) ||
                    item.indonesia.toLowerCase().includes(searchTerm) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm))
                );
                
                vocabularyTable.innerHTML = '';
                filtered.forEach((item, index) => {
                    addRowToTable(item, index + 1);
                });
            }

            // Download Excel template
            function downloadExcelTemplate() {
                // Sample data for the template
                const templateData = [
                    {
                        "Hanzi": "你好",
                        "Pinyin": "nǐ hǎo",
                        "Indonesia": "Halo",
                        "Category": "Sapaan"
                    },
                    {
                        "Hanzi": "谢谢",
                        "Pinyin": "xiè xiè",
                        "Indonesia": "Terima kasih",
                        "Category": "Ucapan"
                    },
                    {
                        "Hanzi": "请",
                        "Pinyin": "qǐng",
                        "Indonesia": "Silakan",
                        "Category": "Permintaan"
                    }
                ];
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(templateData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Vocabulary");
                
                // Generate Excel file and download
                XLSX.writeFile(wb, "Vocabulary_Template.xlsx");
            }

            // Export current vocabulary to Excel
            function exportToExcel() {
                // Prepare data for export
                const exportData = vocabulary.map(item => ({
                    "Hanzi": item.hanzi,
                    "Pinyin": item.pinyin,
                    "Indonesia": item.indonesia,
                    "Category": item.category || "",
                    "Image URL": item.imageUrl || ""
                }));
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Vocabulary");
                
                // Generate Excel file and download
                XLSX.writeFile(wb, "Vocabulary_Export.xlsx");
            }

            // Handle Excel file import
            function handleExcelImport(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first sheet
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        // Filter out empty rows
                        excelImportData = jsonData.filter(row => 
                            row.Hanzi && row.Pinyin && row.Indonesia
                        );
                        
                        // Show preview
                        showExcelPreview(excelImportData);
                    } catch (error) {
                        console.error('Error reading Excel file:', error);
                        alert('Error reading Excel file. Please check the format.');
                    }
                };
                
                reader.readAsArrayBuffer(file);
            }

            // Show Excel import preview
            function showExcelPreview(data) {
                if (!data || data.length === 0) {
                    excelPreview.innerHTML = '<p>No valid data found in the Excel file.</p>';
                    confirmExcelImport.disabled = true;
                    return;
                }
                
                // Create preview table
                let html = `
                    <h3>Preview (${data.length} items)</h3>
                    <table>
                        <thead>
                            <tr>
                                ${Object.keys(data[0]).map(key => `<th>${key}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.slice(0, 5).map(row => `
                                <tr>
                                    ${Object.values(row).map(val => `<td>${val || ''}</td>`).join('')}
                                </tr>
                            `).join('')}
                            ${data.length > 5 ? `<tr><td colspan="${Object.keys(data[0]).length}">...and ${data.length - 5} more rows</td></tr>` : ''}
                        </tbody>
                    </table>
                    <p class="compression-info">Only rows with Hanzi, Pinyin, and Indonesia will be imported.</p>
                `;
                
                excelPreview.innerHTML = html;
                confirmExcelImport.disabled = false;
            }

            // Import data from Excel to Firebase
            // Import data from Excel to Firebase
function importFromExcel() {
    if (!excelImportData || excelImportData.length === 0) {
        alert('No data to import');
        return;
    }
    
    if (!confirm(`Are you sure you want to import ${excelImportData.length} vocabulary items?`)) {
        return;
    }
    
    // Initialize error tracking
    let errors = 0;
    let importedCount = 0;
    
    // Show loading state
    excelPreview.innerHTML = `
        <div style="text-align: center;">
            <div class="spinner"></div>
            <p>Importing ${excelImportData.length} items...</p>
            <p class="compression-info" id="import-progress">0/${excelImportData.length} imported</p>
        </div>
    `;
    confirmExcelImport.disabled = true;
    cancelExcelImport.disabled = true;
    
    // Process each item sequentially to avoid overwhelming Firebase
    const processItem = async (index) => {
        if (index >= excelImportData.length) {
            // Import complete
            excelPreview.innerHTML = `
                <div style="text-align: center;">
                    <h3>Import Complete</h3>
                    <p>Successfully imported ${importedCount} of ${excelImportData.length} items.</p>
                    ${errors > 0 ? `<p class="compression-info">${errors} items failed to import.</p>` : ''}
                </div>
            `;
            
            // Close modal after 2 seconds
            setTimeout(() => {
                excelModal.style.display = 'none';
                cancelExcelImport.disabled = false;
                loadVocabulary(); // Refresh the table
            }, 2000);
            return;
        }
        
        const item = excelImportData[index];
        
        try {
            const vocabItem = {
                hanzi: item.Hanzi?.toString()?.trim() || '',
                pinyin: item.Pinyin?.toString()?.trim() || '',
                indonesia: item.Indonesia?.toString()?.trim() || '',
                category: item.Category?.toString()?.trim() || null,
                imageUrl: item['Image URL']?.toString()?.trim() || null
            };
            
            // Validate required fields
            if (!vocabItem.hanzi || !vocabItem.pinyin || !vocabItem.indonesia) {
                throw new Error('Missing required fields');
            }
            
            const newVocabRef = push(ref(database, 'vocabulary'));
            await set(newVocabRef, vocabItem);
            
            importedCount++;
        } catch (error) {
            console.error('Error importing item:', error);
            errors++;
        }
        
        // Update progress
        document.getElementById('import-progress').textContent = 
            `${importedCount}/${excelImportData.length} imported (${errors} errors)`;
        
        // Process next item with a small delay
        setTimeout(() => processItem(index + 1), 100);
    };
    
    // Start processing
    processItem(0);
}

            // Update import progress
            function updateImportProgress(imported, total) {
                if (imported + errors >= total) {
                    excelPreview.innerHTML = `
                        <div style="text-align: center;">
                            <h3>Import Complete</h3>
                            <p>Successfully imported ${imported} of ${total} items.</p>
                            ${errors > 0 ? `<p class="compression-info">${errors} items failed to import.</p>` : ''}
                        </div>
                    `;
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        excelModal.style.display = 'none';
                        cancelExcelImport.disabled = false;
                    }, 2000);
                }
            }

            // Setup event listeners
            function setupEventListeners() {
                // Add new row button
                addRowBtn.addEventListener('click', addNewRow);
                
                // Search functionality
                searchBtn.addEventListener('click', searchVocabulary);
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchVocabulary();
                });
                
                // Table actions (using event delegation)
                vocabularyTable.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    
                    const row = target.closest('tr');
                    const id = row.dataset.id;
                    
                    if (target.classList.contains('edit-btn')) {
                        editVocabulary(row);
                    } else if (target.classList.contains('delete-btn')) {
                        deleteVocabulary(id);
                    } else if (target.classList.contains('save-btn')) {
                        saveVocabulary(row);
                    } else if (target.classList.contains('cancel-btn')) {
                        cancelEdit(row);
                    }
                });
                
                // Image modal
                closeModal.addEventListener('click', () => {
                    imageModal.style.display = 'none';
                });
                
                // Close modal when clicking outside image
                imageModal.addEventListener('click', (e) => {
                    if (e.target === imageModal) {
                        imageModal.style.display = 'none';
                    }
                });
                
                // Excel import/export buttons
                importExcelBtn.addEventListener('click', () => {
                    excelImportData = [];
                    excelPreview.innerHTML = '';
                    confirmExcelImport.disabled = true;
                    excelModal.style.display = 'block';
                });
                
                exportExcelBtn.addEventListener('click', exportToExcel);
                downloadTemplateBtn.addEventListener('click', downloadExcelTemplate);
                
                // Excel modal events
                closeExcelModal.addEventListener('click', () => {
                    excelModal.style.display = 'none';
                });
                
                cancelExcelImport.addEventListener('click', () => {
                    excelModal.style.display = 'none';
                });
                
                confirmExcelImport.addEventListener('click', importFromExcel);
                
                // Handle Excel file selection
                excelInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        handleExcelImport(file);
                    }
                });
                
                // Handle drag and drop for Excel file
                const excelUploadArea = document.getElementById('excel-upload-area');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    excelUploadArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    excelUploadArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    excelUploadArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    excelUploadArea.classList.add('highlight');
                }
                
                function unhighlight() {
                    excelUploadArea.classList.remove('highlight');
                }
                
                excelUploadArea.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const file = dt.files[0];
                    
                    if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.csv'))) {
                        excelInput.files = dt.files;
                        handleExcelImport(file);
                    } else {
                        alert('Please upload an Excel file (.xlsx, .xls, or .csv)');
                    }
                }
            }

            // Make functions available globally
            window.uploadImage = uploadImage;
            window.showImageModal = showImageModal;

            // Initialize the app
            loadVocabulary();
            setupEventListeners();
        });
    </script>
</body>
</html>